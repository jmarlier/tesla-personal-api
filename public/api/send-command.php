<?php

/**
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * API : Envoyer une commande √† un v√©hicule Tesla
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * 
 * Ce fichier permet d'envoyer des commandes aux v√©hicules Tesla :
 * - wake_up : R√©veiller le v√©hicule
 * - honk : Klaxonner
 * - flash_lights : Flasher les phares
 * - lock : Verrouiller
 * - unlock : D√©verrouiller
 * - climate_on : Activer la climatisation
 * - climate_off : D√©sactiver la climatisation
 * - etc.
 * 
 * REQU√äTE :
 *   POST https://fleet-api.prd.na.vn.cloud.tesla.com/api/1/vehicles/{id}/command/{command}
 * 
 * AUTHENTIFICATION :
 *   - Utilise l'access token de l'utilisateur (depuis la session)
 *   - Header: Authorization: Bearer <user_access_token>
 * 
 * USAGE :
 *   GET /api/send-command.php?vehicle_id=123&command=honk
 *   POST /api/send-command.php (avec vehicle_id et command dans le body)
 * 
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 */

// Format de sortie (d√©tect√© en premier pour le header JSON)
$format = $_GET['format'] ?? 'html';

// Si format JSON demand√©, envoyer le header d√®s le d√©but
if ($format === 'json') {
    header('Content-Type: application/json');
}

require_once __DIR__ . '/../../vendor/autoload.php';

use Dotenv\Dotenv;
use TeslaApp\TeslaFleetClient;

// Englober dans un try/catch pour capturer toutes les erreurs
try {
    $dotenv = Dotenv::createImmutable(__DIR__ . '/../..');
    $dotenv->load();

    session_start();
} catch (Exception $e) {
    if ($format === 'json') {
        echo json_encode([
            'success' => false,
            'error' => 'Configuration error',
            'message' => $e->getMessage()
        ]);
        exit;
    }
    die('Erreur de configuration : ' . $e->getMessage());
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 1. V√âRIFICATION DE L'AUTHENTIFICATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

if (!isset($_SESSION['access_token'])) {
    http_response_code(401);
    header('Content-Type: application/json');
    echo json_encode([
        'error' => 'Unauthorized',
        'message' => 'Vous devez √™tre authentifi√© pour acc√©der √† cette ressource'
    ]);
    exit;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 2. R√âCUP√âRATION DES PARAM√àTRES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

$vehicleId = $_REQUEST['vehicle_id'] ?? null;
$command = $_REQUEST['command'] ?? null;

if (!$vehicleId || !$command) {
    http_response_code(400);
    header('Content-Type: application/json');
    echo json_encode([
        'error' => 'Bad Request',
        'message' => 'Les param√®tres "vehicle_id" et "command" sont requis'
    ]);
    exit;
}

// Commandes disponibles
$availableCommands = [
    'wake_up' => '‚è∞ R√©veiller le v√©hicule',
    'honk' => 'üìØ Klaxonner',
    'flash_lights' => 'üí° Flasher les phares',
    'lock' => 'üîí Verrouiller',
    'unlock' => 'üîì D√©verrouiller',
    'climate_on' => 'üå°Ô∏è Activer la climatisation',
    'climate_off' => '‚ùÑÔ∏è D√©sactiver la climatisation',
    'charge_start' => 'üîå D√©marrer la charge',
    'charge_stop' => '‚è∏Ô∏è Arr√™ter la charge',
    'charge_port_door_open' => 'üö™ Ouvrir la trappe de charge',
    'charge_port_door_close' => 'üö™ Fermer la trappe de charge',
];

$accessToken = $_SESSION['access_token'];
$fleetApiUrl = $_ENV['TESLA_FLEET_API_URL'] ?? 'https://fleet-api.prd.na.vn.cloud.tesla.com';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 3. ENVOI DE LA COMMANDE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

$client = new TeslaFleetClient($accessToken, $fleetApiUrl);

// Cas sp√©cial pour wake_up qui a sa propre m√©thode
if ($command === 'wake_up') {
    $result = $client->wakeUp($vehicleId);
} else {
    $result = $client->sendCommand($vehicleId, $command);
}

$httpCode = $client->getLastHttpCode();
$fullResponse = $client->getLastResponse();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 4. FORMAT JSON
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

if ($format === 'json') {
    header('Content-Type: application/json');

    if ($client->isSuccess()) {
        echo json_encode([
            'success' => true,
            'command' => $command,
            'vehicle_id' => $vehicleId,
            'result' => $result,
            'http_code' => $httpCode
        ], JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES);
    } else {
        http_response_code($httpCode);
        echo json_encode([
            'success' => false,
            'command' => $command,
            'vehicle_id' => $vehicleId,
            'error' => 'Erreur lors de l\'ex√©cution de la commande',
            'http_code' => $httpCode,
            'response' => $fullResponse
        ], JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES);
    }
    exit;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 5. FORMAT HTML
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

?>
<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commande envoy√©e - Tesla</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .response-box {
            background: #f8f9fa;
            border-left: 4px solid #3E6AE1;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .response-box.error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .response-box.success {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .response-box h3 {
            color: #3E6AE1;
            margin-bottom: 15px;
        }

        .response-box.error h3 {
            color: #dc3545;
        }

        .response-box.success h3 {
            color: #28a745;
        }

        pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 13px;
            margin: 10px 0;
        }

        .command-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .command-info h3 {
            color: #3E6AE1;
            margin-bottom: 15px;
        }

        .info-item {
            margin: 10px 0;
            font-size: 14px;
        }

        .info-item strong {
            color: #333;
        }

        .button {
            background: #3E6AE1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-top: 10px;
        }

        .button:hover {
            background: #2E5AC7;
            transform: translateY(-2px);
        }

        .commands-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .command-btn {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: #333;
            display: block;
        }

        .command-btn:hover {
            border-color: #3E6AE1;
            background: #e7f1ff;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° Commande Tesla</h1>
            <div>
                <a href="vehicles.php" class="button">‚Üê Liste des v√©hicules</a>
                <a href="vehicle-data.php?id=<?= htmlspecialchars($vehicleId) ?>" class="button">üìä D√©tails du v√©hicule</a>
            </div>
        </div>

        <!-- Informations de la commande -->
        <div class="command-info">
            <h3>üìã Commande envoy√©e</h3>
            <div class="info-item">
                <strong>V√©hicule ID :</strong> <?= htmlspecialchars($vehicleId) ?>
            </div>
            <div class="info-item">
                <strong>Commande :</strong> <?= htmlspecialchars($command) ?>
                <?php if (isset($availableCommands[$command])): ?>
                    (<?= $availableCommands[$command] ?>)
                <?php endif; ?>
            </div>
        </div>

        <!-- Affichage de la r√©ponse compl√®te de l'API -->
        <div class="response-box<?= $client->isSuccess() ? ' success' : ' error' ?>">
            <h3>üìã R√©ponse compl√®te de l'API Tesla (HTTP <?= $httpCode ?>)</h3>
            <pre><?= json_encode($fullResponse, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES) ?></pre>
        </div>

        <?php if ($client->isSuccess()): ?>

            <div class="response-box success">
                <h3>‚úÖ Commande ex√©cut√©e avec succ√®s</h3>

                <?php if ($result): ?>
                    <div style="margin-top: 15px;">
                        <?php if (isset($result['result']) && $result['result']): ?>
                            <p>‚úÖ La commande a √©t√© accept√©e par le v√©hicule</p>
                        <?php elseif (isset($result['state'])): ?>
                            <p>√âtat du v√©hicule : <strong><?= htmlspecialchars($result['state']) ?></strong></p>
                        <?php endif; ?>

                        <?php if (isset($result['reason']) && $result['reason']): ?>
                            <p>Raison : <?= htmlspecialchars($result['reason']) ?></p>
                        <?php endif; ?>
                    </div>
                <?php endif; ?>
            </div>

        <?php else: ?>

            <div class="response-box error">
                <h3>‚ùå Erreur lors de l'ex√©cution de la commande</h3>
                <p><strong>Code HTTP :</strong> <?= $httpCode ?></p>

                <?php if (isset($fullResponse['error'])): ?>
                    <p><strong>Erreur :</strong> <?= htmlspecialchars($fullResponse['error']) ?></p>
                <?php endif; ?>

                <?php if (isset($fullResponse['error_description'])): ?>
                    <p><strong>Description :</strong> <?= htmlspecialchars($fullResponse['error_description']) ?></p>
                <?php endif; ?>

                <div style="margin-top: 15px;">
                    <p>üí° <strong>Suggestions :</strong></p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Le v√©hicule doit √™tre en ligne (r√©veill√©)</li>
                        <li>Certaines commandes n√©cessitent des conditions sp√©cifiques</li>
                        <li>V√©rifiez que vous avez les permissions n√©cessaires</li>
                    </ul>
                </div>
            </div>

        <?php endif; ?>

        <!-- Autres commandes disponibles -->
        <div class="response-box">
            <h3>‚ö° Autres commandes disponibles</h3>
            <div class="commands-grid">
                <?php foreach ($availableCommands as $cmd => $label): ?>
                    <?php if ($cmd !== $command): ?>
                        <a href="?vehicle_id=<?= htmlspecialchars($vehicleId) ?>&command=<?= htmlspecialchars($cmd) ?>"
                            class="command-btn">
                            <?= $label ?>
                        </a>
                    <?php endif; ?>
                <?php endforeach; ?>
            </div>
        </div>
    </div>
</body>

</html>